@(dataset: models.Dataset,
  comments: List[Comment],
  previewers : List[Previewer],
  m: List[models.Metadata],
  collectionsInside: List[models.Collection],
  rdfExported: Boolean,
  relatedSensors: List[(String,String,String)],
  datasetSpaces: Option[List[ProjectSpace]],
  datasetSpaces_canRemove : Option[Map[ProjectSpace,Boolean]],
  fileList: List[File],
  filesTags: scala.collection.immutable.TreeSet[String],
  toPublish: Boolean,
  curationObjects: List[models.CurationObject],
  currentSpace: Option[String],
  limit: Int)(implicit flash: play.api.mvc.Flash, user: Option[models.User])

@import helper._
@import api.Permission

@main(dataset.name) {
	<div class="row">
		<!-- left column -->
		<div class="col-md-8 col-right-border">
            <div class="row">
                <div class="col-md-12 caption break-word" id="ds-title">
                    <h1 id="datasettitle" class="inline">@Html(dataset.name)</h1>
                    @if(Permission.checkPermission(Permission.EditDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                        <h3 id="h-edit-title" class="hiddencomplete">
                            <a id ="edit-title" href = "javascript:updateTitle()" title="Click to edit title">
                            <span class ="glyphicon glyphicon-edit" aria-hidden ="true"></span>
                            </a>
                        </h3>
                    }

                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li>Created by <a href= "@routes.Profile.viewProfile(dataset.author.email)"> @dataset.author.fullName </a></li>
                        <li>Created on @dataset.created.format("MMM dd, yyyy")</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <div id="edit-license">
                        <li class="inline"><span id="licensetextdata">blank</span> <span id="rightsholderdata">blank</span></li>
                            @if(Permission.checkPermission(Permission.EditLicense, ResourceRef(ResourceRef.dataset, dataset.id))) {

                                <a class="edit-tab hiddencomplete" data-toggle="collapse"
                                data-parent="#accordion6" href="#collapseSix" id="editlicense"
                                title=" Click to Edit License Information">
                                    <span class="glyphicon glyphicon-edit"></span>
                                </a>

                            }
                        </div>
                        @datasets.editLicense(dataset)
                    </ul>
                </div>
                <div class="col-md-12 box-white-space" id="aboutdesc">
                    <p id ="ds_description" class="inline">@if(dataset.description.length > 0) { @Html(dataset.description) } else {Add a description}</p>
                    @if(Permission.checkPermission(Permission.EditDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                        <a id="edit-description" class="hiddencomplete" href="javascript:updateDescription()" title="Click to edit description">
                            <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                        </a>
                    }
            </div>
                <div class="col-md-12 box-white-space">
                    <!-- If the user can add files to the dataset, the button is enabled, otherwise the button is present but disabled to provide consistent UE. -->
                    @if(Permission.checkPermission(Permission.AddResourceToDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                        <a id="addFilesLink" href="@(routes.Datasets.addFiles(dataset.id))"
                        class="btn btn-link btn-sm btn-margin-bottom" id="fileUploadBtn" title="Add File to Dataset" role="button">
                            <span class="glyphicon glyphicon-plus"></span> Add Files
                        </a>
                    }
                    @if(dataset.files.length > 0 && Permission.checkPermission(Permission.DownloadFiles, ResourceRef(ResourceRef.dataset, dataset.id))) {
                        <a id='download-dataset-url' href="#"
                        onclick="window.open(jsRoutes.api.Datasets.download('@dataset.id').url, '_blank');"
                        class="btn btn-link btn-sm requiresLogin btn-margin-bottom" title="Download All Files as Zip" role="button">
                            <span class="glyphicon glyphicon-download-alt"></span>
                            Download All Files
                        </a>
                    }
                    @datasets.deleteButton(dataset)
                    @datasets.follow(dataset)
                    @if(user.isDefined && play.api.Play.current.plugin[services.StagingAreaPlugin].isDefined) {
                        @if(toPublish && currentSpace.isDefined && Permission.checkPermission(Permission.EditStagingArea, ResourceRef(ResourceRef.space, UUID(currentSpace.getOrElse(""))))) {
                            <a href="@(routes.CurationObjects.newCO(dataset.id, currentSpace.get))" class="btn btn-link btn-sm btn-margin-bottom">
                                <span class="glyphicon glyphicon-globe"></span> Publish
                            </a>
                        } else {
                            @if(dataset.spaces.size > 0) {
                                <a href="@(routes.CurationObjects.newCO(dataset.id, ""))" class="btn btn-link btn-sm btn-margin-bottom">
                                    <span class="glyphicon glyphicon-globe"></span> Publish
                                </a>
                            } else {
                                <button class="btn btn-link btn-sm btn-margin-bottom" disabled>
                                    <span class="glyphicon glyphicon-globe"></span> Publish
                                </button>
                            }
                        }
                    }
                    @if(Permission.checkPermission(Permission.AddResourceToDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                        <a data-toggle="modal" data-target="#folder-modal" class="btn btn-link btn-sm btn-margin-bottom">
                            <span class="glyphicon glyphicon-ok"></span> Create Folder
                        </a>
                        <div class="modal fade" id="folder-modal" tabindex="-1" role ="dialog" aria-labelledby="folder-modal-label">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 class="modal-title" id="folder-modal-label"> Create new Folder</h4>
                                    </div>
                                    <div class="modal-body">
                                        <div class="form-group">
                                            <label id="namelabel" for="name">Name</label>
                                            <input type="text" class="form-control" id="name" placeholder="A short name">
                                            <span class="error hiddencomplete" id="nameerror">The name is a required field</span>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary start"  id="createFolder" title="Create the Dataset">
                                            <span class="glyphicon glyphicon-ok"></span> Create Folder
                                        </button>
                                        <button class="btn btn-default" title="Cancel creation of folder" data-dismiss="modal">
                                            <span class="glyphicon glyphicon-remove"></span> Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
	    	<div class="tabbable" id="bottomDatasetTabbable"> <!-- Only required for left/right tabs -->
                <ul class="nav nav-tabs margin-bottom-20" >
                    <li role="presentation" class="active"><a href="#tab-files" role="tab" data-toggle="tab">Files </a></li>
                    <li role="presentation"><a href="#tab-metadata" role="tab" data-toggle="tab">Metadata </a></li>
                    <li role="presentation"><a href="#tab-visua" role="tab" data-toggle="tab">Visualizations</a></li>
                    <li role="presentation"><a href="#tab-comments" role="tab" data-toggle="tab">Comments (@comments.size)</a></li>
                </ul>
                <div class="tab-content">
                  <div role="tabpanel" class="tab-pane  fade in active" id="tab-files">

                  </div>
                  <div role="tabpanel" class="tab-pane fade" id="tab-comments">
                      <!-- If the user can add comments, the form will be present, otherwise the form is not available at all. -->
                      @if(Permission.checkPermission(Permission.AddComment, ResourceRef(ResourceRef.dataset, dataset.id))) {
                          @commentform(dataset.id.stringify, "dataset")
                      }
                      <div class="list-unstyled" id="reply_@dataset.id.toString">
                         @comment(comments)</div>
                  </div>
                  <div role="tabpanel" class="tab-pane fade" id="tab-metadata">

                      <div class="row">
                          <div class="col-md-10">
                          </div>
                          <div class="col-md-2">
                              <a href="@api.routes.Datasets.getMetadataJsonLD(dataset.id)" class="pull-right" title="JSON-LD">
                                  <img src="@routes.Assets.at("images/json-ld.png")"/>
                              </a>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-12">
                            @metadatald.addMetadata("dataset", dataset.id.toString, "metadata-content")
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-12" id="metadata-content">
                          @metadatald.view(m, true)
                          </div>
                      </div>


                  </div>
                    <div role="tabpanel" class="tab-pane fade" id="tab-visua">
                    @datasets.previews(dataset, previewers)
                    </div>
            </div>
        </div>
    </div>

		<!-- right column -->
		<div class="col-md-4 col-left-border">
            @spaces.spaceAllocation(dataset.id, ResourceRef.dataset, datasetSpaces.getOrElse(List.empty),None)
            @if(user.isDefined) {
                <br/>
                @datasets.userLink(dataset)
            }
            @datasets.collections(dataset, collectionsInside)
            @datasets.tags(dataset, fileList, filesTags)
            @if(play.api.Play.current.plugin[services.StagingAreaPlugin].isDefined) {
                @datasets.listCurationObjects(curationObjects)
            }
            @if(play.api.Play.current.plugin[services.PostgresPlugin].isDefined) {
                @sensors.relatedSensors(relatedSensors, "Dataset", dataset.id.stringify)
            }
		</div>
	</div>

    @* FIXME Commented out since it creates some issues with dataset previewers *@
    @*<script src="@routes.Assets.at("javascripts/tabsInURL.js")" type="text/javascript"></script>*@

    <script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/updateLicenseInfo.js")" language="javascript"></script>
    <script src="@routes.Assets.at("javascripts/datasetListProcess.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/folderListProcess.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/fileListProcess.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/follow-button.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/deleteUtils.js")" type="text/javascript"></script>
    <script type="text/javascript">
        var removeIndicator = false;
        var parentId = "@dataset.id";
        var parentType = "dataset";
        var pageIndex = 0;
        var folderId;
        var cur_title;
        function updateTitle() {
            cur_title = $('#datasettitle').text();
            $('<span class="inline edit_title_div"> </span>').insertAfter($('#datasettitle'));
            $('.edit_title_div').append('<input type="text" id = "title_input" class="form-control" required/>');
            $('.edit_title_div').append('<div class="hiddencomplete" aria-hidden="true" id="title-error"> <span class="error"> Title is required </span> </div>');
            $('.edit_title_div').append('<button id="update_title" class= "btn btn-sm btn-primary btn-margins" onclick="saveTitle()"> <span class="glyphicon glyphicon-send"></span> Save </button>');
            $('.edit_title_div').append('<button id="cancel_title" onclick="cancelTitle()" class="btn btn-sm edit-tab btn-default btn-margins"> <span class="glyphicon glyphicon-remove"></span>Cancel </button>');
            $('#title_input').val(cur_title);
            $('#datasettitle').text("");
            $('#h-edit-title').addClass("hiddencomplete");
            $('#h-edit-title').css("display", "none");
        }
        function parseHash() {
            var hash = location.hash.split('#')[1];
            var folderSet = false;
            var pageSet = false;
            if(hash != undefined) {
                var values = hash.split('&');
                for (var i = 0; i < values.length; i++){
                    var temp = values[i].split('=');
                    if(temp[0] == 'folderId') {
                        folderId = temp[1];
                        folderSet = true
                    }
                    if(temp[0] == 'page'){
                        pageIndex = temp[1];
                        pageSet = true
                    }
                }
            }
            if(!folderSet) {
                folderId ='';
            }
            if(!pageSet) {
                pageIndex = 0;
            }
        }
        $(document).ready(function(){

            getUpdatedFilesAndFolders();

            if(@dataset.spaces.size < 1 ) {
                $('#dataset-users').hide();
            }

            if(@Permission.checkPermission(Permission.EditDataset, ResourceRef(ResourceRef.dataset, dataset.id))) {
                 $(document).on('mouseenter', '#ds-title', function() {
                    $('#h-edit-title').removeClass("hiddencomplete");
                    $('#h-edit-title').addClass("inline");
                 }).on('mouseleave', '#ds-title', function() {
                    $('#h-edit-title').removeClass("inline");
                    $('#h-edit-title').addClass("hiddencomplete");
                 });

                 $(document).on('mouseenter', '#aboutdesc', function() {
                    $('#edit-description').removeClass("hiddencomplete");
                    $('#edit-description').addClass("inline");
                 }).on('mouseleave', '#aboutdesc', function() {
                    $('#edit-description').removeClass("inline");
                    $('#edit-description').addClass("hiddencomplete");
                 });
            }

            if(@Permission.checkPermission(Permission.EditLicense, ResourceRef(ResourceRef.dataset, dataset.id))) {
                $(document).on('mouseenter', '#edit-license', function() {
                    $('#editlicense').removeClass("hiddencomplete");
                    $('#editlicense').addClass("inline");
                }).on('mouseleave', '#edit-license', function() {
                    $('#editlicense').removeClass("inline");
                    $('#editlicense').addClass("hiddencomplete");
                });
            }

            var description = $('#ds_description').html().trim();
            $('#ds_description').html(urlify(description));

        });

        function cancelTitle() {
              $('#datasettitle').text(cur_title);
              $('.edit_title_div').remove();
              $('#datasettitle').css("display", "inline");
              $('#h-edit-title').removeClass("inline");
              $('#h-edit-title').css("display", "");
              $('#ds-title').mouseleave();
        }

        function saveTitle() {
            if($('#title_input').val().length < 1) {
                $('#title-error').show();
                return false;
            }
            var name = $('#title_input').val();
            var encName = htmlEncode(name);
            jsonData = JSON.stringify({"name": encName});

            var request = jsRoutes.api.Datasets.updateName("@dataset.id").ajax({
                data: jsonData,
                type: 'PUT',
                contentType: "application/json"
            });

            request.done(function(response, textStatus, jqXHR){
                $('#datasettitle').text(encName.replace(/\n/g, "<br>"));
                $('.edit_title_div').remove();
                $('#datasettitle').css("display", "inline");
                $('#h-edit-title').removeClass("inline");
                $('#h-edit-title').css("display", "");
                $('#ds-title').mouseleave();
                notify("Dataset name updated successfully", "success", false, 2000 );
            });

            request.fail(function(jqXHR, textStatus, errorThrown) {
                console.error("The following error occurred: " + textStatus, errorThrown);
                var errMsg = "Yoy must be logged in to update the information about a dataset.";
                if(!checkErrorAndRedirect(jqXHR, errMsg)) {
                    notify("The dataset information was not updated due to: "+ errorThrown, "error");
			    }
		    });

        }
    var cur_description;
    function updateDescription() {
		cur_description = $('#ds_description').html().trim();
		$('<div class="edit_desc"> </div>').insertAfter($('#ds_description'));
		$('.edit_desc').append('<textarea id = "desc_input" class="form-control"/>');
		$('.edit_desc').append('<button id = "update_desc" class= "btn btn-sm btn-primary btn-margins" onclick = "saveDescription()"> <span class="glyphicon glyphicon-send"> </span> Save </button>');
		$('.edit_desc').append('<button id="cancel_desc" class="btn btn-sm edit-tab btn-default btn-margins" onclick="cancelDescription()"> <span class="glyphicon glyphicon-remove"></span> Cancel </button>');
		if(cur_description.indexOf("Add a description") != 0) {
		    $('#desc_input').val(htmlDecode(cur_description.replace(new RegExp("<br>", "g"), "\n")));
		}
		$('#ds_description').text("");
		$('#edit-description').css("display", "none");
		$('#edit-description').addClass("hiddencomplete");
	}

    function cancelDescription() {
        $('#ds_description').html(cur_description);
        $('.edit_desc').remove();
        $('#ds_description').css("display", "inline");
        $('#edit-description').removeClass("inline");
        $('#edit-description').css("display", "");
        $('#ds-description').mouseleave();
    }

	function saveDescription() {
		var description = $('#desc_input').val();
		var encDescription = htmlEncode(description);
		jsonData = JSON.stringify({"description": encDescription});

		var request = jsRoutes.api.Datasets.updateDescription("@dataset.id").ajax({
			data: jsonData,
			type: 'PUT',
			contentType: "application/json"
		});

		request.done(function(response, textStatus,jqXHR) {
			$('#ds_description').html(urlify(htmlEncode(description).replace(/\n/g, "<br>")));
			$('.edit_desc').remove();
			$('#ds_description').css("display", "inline");
			$('#edit-description').removeClass("inline");
            $('#edit-description').css("display", "");
            $('#ds-description').mouseleave();
            notify("Dataset description updated successfully", "success", false, 2000 );
		});

		request.fail(function(jqXHR, textStatus, errorThrown) {
			console.error("The following error occurred: " + textStatus, errorThrown);
			var errMsg = " You must be logged in to update the information about a collection.";
			if(!checkErrorAndRedirect(jqXHR, errMsg)) {
				notify("The collection information was not updated due to: " + errorThrown, "error");
			}
		});

	 }

    function urlify(text) {
        var urlRegex =/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@@#\/%?=~_|!:,.;]*[-A-Z0-9+&@@#\/%=~_|])/ig;
        return text.replace(urlRegex, function(url) {
            return '<a href="' + url + '">' + url + '</a>';
        })
    }

    $(function() {
            $(window).on('fileDelete hashchange', function() {

                getUpdatedFilesAndFolders();
            });

            $('#createFolder').click(function() {
                var name=$('#name');

                var error = false;
                if(!name.val()) {
                    $('#nameerror').show();
                    error = true;
                }
                if(!error) {

                    var encName  = htmlEncode(name.val());
                    var jsonData = JSON.stringify({"name": encName, "parentId": parentId, "parentType": parentType, "currentSpace": "@currentSpace"});
                    var request = jsRoutes.controllers.Folders.createFolder("@dataset.id").ajax({
                        data:jsonData,
                        type: 'POST',
                        contentType: "application/json"
                    });
                    request.done(function(response, textStatus, jqXHR){
                        $('#folder-modal').modal('hide');
                        $('#folderListDiv').prepend(response);
                        notify("Folder created successfully", "success", false, 2000 );
                        $('#name').val("");
                    });

                    request.fail(function (jqXHR, textStatus, errorThrown){
                        $('#name').val("");
                        console.error("The following error occured: " + textStatus, errorThrown);
                        var errMsg = "You must be logged in to create a new folder.";
                        if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                            notify("Error in creating folder: " + errorThrown, "error");
                        }
                    });

                };
                return false;
            });
        });

       function updatePageAndFolder(idx, folderIdd){
           if(folderIdd != "") {
               location.hash = "folderId="+folderIdd+"&page="+idx;
           } else {
               location.hash="page="+idx;
           }
           $(window).trigger("hashchange");
       }

       function getUpdatedFilesAndFolders() {
        parseHash();
        if(folderId == "") {
            folderId = null;
        }
        var currentSpace = null;
        if(@currentSpace.isDefined){
           currentSpace = "@currentSpace";
        }
         var jsonData = JSON.stringify({"currentSpace": currentSpace, "folderId": folderId});
         var request = jsRoutes.controllers.Datasets.getUpdatedFilesAndFolders("@dataset.id", @limit, pageIndex).ajax({
            data: jsonData,
            type: 'POST',
            contentType: "application/json"
         });

         request.done(function(response, textStatus, jsXHR){
          $('#tab-files').html("");
          $('#tab-files').html(response);
          if(folderId != null) {
            parentType = 'folder';
            parentId = folderId;
            $('#addFilesLink').attr("href", jsRoutes.controllers.Folders.addFiles('@dataset.id', folderId).url);
          } else {
              parentId = "@dataset.id";
              parentType = "dataset";
              $('#addFilesLink').attr("href", jsRoutes.controllers.Datasets.addFiles('@dataset.id').url);
          }
         });
         request.fail(function (jqXHR, textStatus, errorThrown){
            console.error("The following error occured: " + textStatus, errorThrown);
            var errMsg = "You must be logged in to see files and folders.";
            if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                notify("Error in getting more files and folders. : " + errorThrown, "error");
            }
         });

       }

    </script>
}

