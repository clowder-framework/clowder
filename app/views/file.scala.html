@(file: models.File, id: String, comments: List[Comment],
  previews : Map[models.File, Array[(java.lang.String, String, String, String, java.lang.String, String, Long)]],
  sections: List[models.Section], beingProcessed: Boolean, fileDataset: List[models.Dataset],
  datasetsOutside: List[models.Dataset], usrmd: scala.collection.mutable.Map[String,Any],
  rdfExported: Boolean,
  extractionsStatus: List[Extraction])(implicit user: Option[models.User])

@import helper._
@import collection.JavaConverters._
@import play.api.Play.current
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

	@printLevel(metadata: scala.collection.immutable.Map[String,Any]) = {
		@for((key,value) <- metadata) {
			<li><b>@(key):</b>
			@if(value.isInstanceOf[String]) {
				@if(value.asInstanceOf[String].startsWith("http://") || value.asInstanceOf[String].startsWith("https://")) {
					<a href="@value">@value</a>
				} else {
					@value
				}
			} else {
				@if(value.isInstanceOf[java.lang.Integer] || value.isInstanceOf[java.lang.Double] || value.isInstanceOf[java.lang.Float] ) {
					@value.toString
				} else {
					@if(value.isInstanceOf[com.mongodb.BasicDBList]) {
						<ul>
							@printList(value.asInstanceOf[com.mongodb.BasicDBList].toList)
						</ul>
					} else {
						@if(value.isInstanceOf[com.mongodb.BasicDBObject]) {
							<ul>
							  @printLevel(value.asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
							</ul>
						} else {
							@value.toString
						}
					}
				}
			}</li>
		}
	}

	@printList(metadata: List[AnyRef])	= {
		@metadata.indices.map { i =>
			<li><b>@i:</b>
				@if(metadata(i).isInstanceOf[String]) {
					@if(metadata(i).asInstanceOf[String].startsWith("http://") || metadata(i).asInstanceOf[String].startsWith("https://")) {
						<a href="@metadata(i)">@metadata(i)</a>
					} else {
						@metadata(i)
					}
				} else {
					@if(metadata(i).isInstanceOf[java.lang.Integer] || metadata(i).isInstanceOf[java.lang.Double] || metadata(i).isInstanceOf[java.lang.Float] ) {
						@metadata(i).toString
					} else {
						@if(metadata(i).isInstanceOf[com.mongodb.BasicDBList]) {
							<ul>
							@printList(metadata(i).asInstanceOf[com.mongodb.BasicDBList].toList)
							</ul>
						} else {
							@if(metadata(i).isInstanceOf[com.mongodb.BasicDBObject]) {
								<ul>
								@printLevel(metadata(i).asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
								</ul>
							} else {
								@metadata(i)
							}
						}
					}
				}</li>
		}
	}

@showPreview(id: String, p: (java.lang.String, String, String, String, java.lang.String, String, Long), filename: String, contentType: String) = {
	<script>
		Configuration.tab = "#previewer_@id";
		Configuration.url = "@p._5";
		Configuration.fileid = "@p._1";
		Configuration.previewer = "@routes.Assets.at(p._3)";
		if("@p._2" === "Thumbnail"){
			Configuration.fileType = "@p._6";
			Configuration.fileSize = @p._7;
		}
		else if("@p._2" === "X3d"){
			Configuration.annotationsEditPath = "@api.routes.Previews.editAnnotation(UUID(p._1)))";
			Configuration.annotationsListPath = "@api.routes.Previews.listAnnotations(UUID(p._1))";
			Configuration.annotationsAttachPath = "@api.routes.Previews.attachAnnotation(UUID(p._1))";
			Configuration.wasPTM = "@(filename.endsWith(".ptm") || contentType.contains("ptmimages"))";
			Configuration.calledFrom = "file";
		}
		else if("@p._2" === "Oni"){			
		}
		else if("@p._2" === "Video"){
			Configuration.fileType = "@p._6";
		}
		else if("@p._2" === "Video presentation"){
			Configuration.authenticatedFileModify = false;
			@if(user.isDefined) {
	     	 	@if(user.get.identityId.userId.equals(file.author.identityId.userId)){
					Configuration.authenticatedFileModify = true;
	     	 	}
			}			
		}
	</script>
	<script type="text/javascript" src="@(routes.Assets.at(p._3) + "/" + p._4)"></script>
}

@main("File") {
@defining(play.api.Play.configuration.getBoolean("navOnSectionClick").getOrElse(true)){navOnSectionClick=>	
    <script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/updateLicenseInfo.js")" language="javascript"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
    <script src="@routes.Assets.at("javascripts/previews.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/tinymce/tinymce.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/popcorn-complete.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/galleria-1.2.9.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/fileListProcess.js")" type="text/javascript"></script>
    
	<script>
		tinymce.init({selector:'.notesArea',
	    	theme: "modern",
	    	plugins: [
	    	          "advlist autolink lists link image charmap print preview hr anchor pagebreak",
	    	          "searchreplace wordcount visualblocks visualchars code fullscreen",
	    	          "insertdatetime media nonbreaking save table contextmenu directionality",
	    	          "template paste textcolor"
	    	      ],
	    	      toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
	    	      toolbar2: "print preview media | forecolor backcolor emoticons",
	    	      image_advtab: true,
	    	      templates: [
	    	          {title: 'Test template 1', content: 'Test 1'},
	    	          {title: 'Test template 2', content: 'Test 2'}
	    	      ]
	    });
	</script>
	<script>
    	var isPageLoaded = false;
    	var isx3dActive = false;
    	var Configuration = {};
    	Configuration.id  = "@file.id";
		Configuration.authenticated = @user.isDefined;
		Configuration.ptmAppletPath = "@(routes.Assets.at("plugins") + "/" + "envlib.jar")";
		Configuration.expressInstallPath = "@(routes.Assets.at("plugins") + "/" + "expressInstall.swf")";
		Configuration.iipZoomPath = "@(routes.Assets.at("plugins") + "/" + "IIPZoom.swf")";
		Configuration.jsPath = "@(routes.Assets.at("javascripts"))";
		Configuration.imagesPath = "@(routes.Assets.at("images"))";
		Configuration.appContext = "@play.api.Play.configuration.getString("application.context").getOrElse("")";
    </script>
    <script>
    	window.onload = function() {
    		isPageLoaded = true;
    	}
    </script>

	<div class="row">
		<div class="col-md-8 col-right-border">
		@for((f, pvs) <- previews) {
			<div class="row" id="filePrevContainer_@(f.id.toString)" data-previewsCount="@(pvs.length)" data-filename="@f.filename">
		    	<div class="col-md-12">
		    	<!-- 
		    	First check if there is only one previewer, and if the value of the URL for it is "null". If so
		    	that means there was no preview generated and the file is not allowed to be used due to the license
		    	that is on the file.
		    	 -->
		    	@if(pvs.length == 1 && pvs(0)._5 == "null") {
                    <h4>No previews currently available for this file</h4>
                } else {
			  		<div class="tabbable">
						<ul class="nav nav-pills" id="myTab_@(f.id.toString)">
							@for(i <- pvs.indices) {
					    		<li class=""><a href="#previewer_@(f.id.toString)_@i" data-toggle="tab">@pvs(i)._2</a></li>
			  				}
						</ul>
						<div class="tab-content"  id="previewsContent_@(f.id.toString)">						    						    
						    @for(i <- pvs.indices) {
						  		<div class="tab-pane previewDiv" id="previewer_@(f.id.toString)_@i" data-previewId="@(pvs(i)._1)" data-previewerId="@(pvs(i)._2)"></div>
						  		@showPreview(f.id.toString + "_" + i, pvs(i), f.filename, f.contentType)

							}							
				  			<script type="text/javascript">
								$(function () {
									$('#myTab_@(f.id.toString) a:first').tab('show');
				 				 })
							</script>
						</div>
					</div>
			    }
		  		</div>
			</div>
			@if(pvs.length <= 1) {
				<script>				
	    			$('#myTab_@(f.id.toString)').attr('style', 'display:none;');
	    		</script>
    		}

        <div class="row">
            <div class="col-md-12 button-margins">                
            	<span class="button-bar">
                    <button id="downloadButton" onclick="return downloadFile();" class="btn btn-primary" title="You don't have permission to download this file" disabled="disabled"><span class="glyphicon glyphicon-save"></span> Download</button>
                </span>
                @if(user.isDefined) {
                <!-- If user can delete, the button is enabled, otherwise the button is present but disabled to provide consistent UE. -->                
                    @if(user.get.identityId.userId.equals(file.author.identityId.userId)){                    
                        <span class="align-right">
				            <button id="deleteButton" onclick="removeFileAndRedirect('@(file.id)','@(routes.Files.list(""))')" class="btn btn-primary" title="Delete">
						    <span class="glyphicon glyphicon-trash"></span> Delete</button>
					    </span>
					} else {
					    <span class="align-right">
                            <button disabled id="deleteButton" onclick="removeFileAndRedirect('@(file.id)','@(routes.Files.list(""))')" class="btn btn-primary" title="Delete">
                            <span class="glyphicon glyphicon-trash"></span> Delete</button>
                        </span>
					}

                    @if(!file.followers.contains(user.get.id)) {
                        <button id="followButton"
                                class="btn btn-success followButton"
                                objectId="@file.id"
                                objectName="@file.filename"
                                objectType="file">
                            Follow
                        </button>
                    } else {
                        <button id="followButton"
                                class="btn btn-danger followButton"
                                objectId="@file.id"
                                objectName="@file.filename"
                                objectType="file">
                            Unfollow
                        </button>
                    }
                }
            </div>
        </div>

        <div id="recommendPanel" class="panel panel-default" style="display : none;">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-parent="#accordion"
                    href="#collapseThree"
                    aria-expanded="true"
                    style="float:left;">
                      Also follow these?
                    </a>
                    <a style="float:right;" href="javascript:$('#recommendPanel').slideToggle('slow');">x</a>
                    <div style="clear : both;"></div>
                </h4>
            </div>
            <div id="collapseThree" class="panel-collapse collapse in" aria-expanded="true">
                <div id="recommendDiv" class="panel-body">
                  </div>
            </div>
        </div>

			<!-- sections -->
			@if(sections.size > 0) {
			  	<div class="row border-top">
			  	  <div class="col-md-12">
                    <h4>Sections</h4>
				  	<div class="galleriaHelp">Click on icon at bottom-right of gallery to toggle sections gallery fullscreen view</div>
				  	<div id="galleria" style="float:left;clear:none;width:100%;height:400px;">					  	
				  	</div>
				  	<script type="text/javascript">
				  		$(document).ready(function() {
				  			window["currGalleriaWidth"]= $("#galleria").css("width").replace("px","");
				  			$(window).resize(function(){
				  				newWidth = $("#galleria").css("width").replace("px","");
				  				if(newWidth != window["currGalleriaWidth"]){
				  					$("#galleria").css("height", Math.round(parseInt($("#galleria").css("height").replace("px",""))*parseInt(newWidth)/parseFloat(window["currGalleriaWidth"]))+"px" );
				  					window["currGalleriaWidth"]=newWidth;
				  				}		
				  			});
				  		});
				  	</script>
				  </div>
				</div>
				<div class="row" style="padding-top: 10px">
				    <div class="col-md-12">
						<table class="table" id="scrollTableGalleria">
							<thead>
								<tr>
									<th class="galleriaOrder">#</th>
									<th class="galleriaTheThumbnail">Thumbnail</th>
									<th class="galleriaInfo">Information</th>
									<th class="galleriaFindSimilar">Find</th>
								</tr>
							</thead>
							<tbody>
					  		@sections.map { s =>
					  			<tr>
						  			<td class="galleriaOrder">@(if (s.order > 0) s.order else "")</td>
						  			<td class="galleriaTheThumbnail">
								  		@if(s.preview.isDefined || s.thumbnail_id.isDefined) {
								  			@if(s.thumbnail_id.isDefined){
								  				<img src="@(routes.Files.thumbnail(UUID(s.thumbnail_id.get)))"				  			
								  			} else {
								  				<img src="@api.routes.Previews.download(s.preview.get.id)"
								  			}
								  				class="img-polaroid" style="max-width: 100%;"
								  			@if(s.startTime.isDefined) {
								  		 		data-title="Shot" data-description="Starts at @s.startTime seconds."
								  		 	} else {
								  		 		@if(s.area.isDefined) {
								  		 			data-title="Area" data-description="@s.area.toString"
								  		 		} else {
													data-title="Unknown" data-description="Unknown info"
								  		 		}
								  		 	}
								  		 	></img>
								  		}
					  				</td>
						  			 <td class="galleriaInfo">
						  			 @if(s.startTime.isDefined) {
						  			 	@(s.startTime.get / 60):@("%02d".format(s.startTime.get % 60))
						  		 	 } else {
						  		 		@if(s.area.isDefined) {
						  		 			@s.area.get.toString
						  		 		} else {
											Unknown info
						  		 		}
						  		 	}
						  			 </td>
						  			 <td class="galleriaFindSimilar"><a href="@routes.Search.searchMultimediaIndex(s.id)">Similar</a></td>
					  			 </tr>
					  		}
					  		</tbody>
					  		<script>
					  			function fixGalleriaTable(){
					  				galleriaScenesVisible = $("#scrollTableGalleria tbody tr").length;
						  			if(galleriaScenesVisible > 5)
						  				galleriaScenesVisible = 5;					  		
						  			$("#scrollTableGalleria tbody").css("height", (parseInt($("#scrollTableGalleria tbody tr").css("height").replace("px",""))*galleriaScenesVisible)+"px");
					  			}
					  			fixGalleriaTable();
					  			$(window).resize(function(){
					  				fixGalleriaTable();
					  			});
					  		</script>
				  		</table>
				  	</div>
			  	</div>
				
				@if(!navOnSectionClick){
					<script>
					    document.addEventListener("DOMContentLoaded", function () {
							if ($("#ourvideo").length>0) {
						        var pop = Popcorn("#ourvideo");
	
								@sections.map { s =>
						  			@if(s.startTime.isDefined) {
								   		pop.code({
									        start: @s.startTime,
									        onStart: function() {
									          var frame = @s.order - 1;
									          console.log("Jumping to " + frame + " " + @s.startTime);
									          $('#galleria').data('galleria').show(frame);
									        },
									        onEnd: function() {
									          //console.log("end");
									       }
									    });
									}
							    }
							}
					    });
			         </script>
		         }
			    
			    <script>
			    	$(function() {
					    // Load the classic theme
					    Galleria.loadTheme('@routes.Assets.at("javascripts/galleria-classic/galleria.classic.min.js")');

						galleriaData = [];
					    @sections.map { s =>
							@if(s.preview.isDefined) {
								galleriaItem = {};
								galleriaItem["image"] = "@api.routes.Previews.download(s.preview.get.id)"; 					  			
								@if(s.startTime.isDefined) {
									galleriaItem["title"] = "Shot";
									galleriaItem["description"] = "Starts at @s.startTime seconds.";
							 	} else {
							 		if (s.area.isDefined) {
							 			galleriaItem["title"] = "Area";
							 			galleriaItem["description"] = "@s.area.toString";
							 		} else {
							 			galleriaItem["title"] = "Unknown";
							 			galleriaItem["description"] = "Unknown info";
							 		}
							 	}
								galleriaData.push(galleriaItem);
							}							
						}

					    @if(navOnSectionClick){
					    	Galleria.configure({
						        showInfo: false
						    });
					         // Initialize Galleria and, if for a video, onclick events for going to time of selected image when clicking main image
						    Galleria.run('#galleria', {					   		
							        extend: function(options) {
							          if ($("#ourvideo").length>0) {
							            Galleria.log(this); // the gallery instance
							            Galleria.log(options); // the gallery options
		
							            // listen to when an image is shown
							            this.bind('image', function(e) {
		
							                Galleria.log(e); // the event object may contain custom objects, in this case the main image
							                Galleria.log(e.imageTarget); // the current image
		
							                // lets make galleria make the video jump to the time of the selected image when clicking it:
							                $(e.imageTarget).click(this.proxy(function(){
							                	var pop = Popcorn("#ourvideo");
							                	pop.currentTime(parseInt(this._data[this._active].description.match(/\d+/)[0]));
							                }));
							            });
							          }
							        },
							        dataSource: galleriaData
						    });
					    }
					    @if(!navOnSectionClick){
					    	// Initialize Galleria
					    	Galleria.run('#galleria', {dataSource: galleriaData});
					    }

					    var gallery = $('#galleria').data('galleria');

						Galleria.ready(function(options) {
						    // 'this' is the gallery instance
						    // 'options' is the gallery options
						    this.bind('image', function(e) {
						        Galleria.log('Now viewing ' + e.imageTarget.src);
						    });
						    var gallery = this; // galleria is ready and the gallery is assigned
						    this.addElement('fscr');
						    this.appendChild('stage','fscr');
						    var fscr = this.$('fscr')
						        .click(function() {
						            gallery.toggleFullscreen();
						        });
						});
				    });
			    </script>
    			}
    		}

            <div class="row">
                <div class="col-md-12 border-top col-section">
                    <h4>Notes</h4>
                    @notesform(file.id.toString, api.routes.Files.setNotesHTML(file.id).toString, file.notesHTML.getOrElse(""))
                </div>
            </div>

            <div class="row border-top">
                <div class="col-md-12">
                    <h4>Community generated metadata</h4>
                    @fileusermetadata(file, usrmd, rdfExported)
                </div>
            </div>

            <div class="row border-top">
                <div class="col-md-12">
                    <h4>System generated metadata</h4>
                    <div id='technicalMetadata_@(file.id)'>
                        <button class="tech_md_ btn btn-link btn-sm" type="button">Show file technical metadata</button>
                        <div style="display:none;">
                        <ul>
                            @for(i <- 0 until file.metadata.length){
                                @printLevel(file.metadata(i).asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
                            }
                        </ul>
                        </div>
                    </div>
                    <script>
                        $("#technicalMetadata_@(file.id.toString) > button").on('click',function(){
                            if($("#technicalMetadata_@(file.id.toString) > div").attr('style') == 'display:none;'){
                                $("#technicalMetadata_@(file.id.toString) > div").attr('style', 'display:block;');
                                $("#technicalMetadata_@(file.id.toString) > button").get(0).innerHTML = "Hide file technical metadata";
                            }
                            else{
                                $("#technicalMetadata_@(file.id.toString) > div").attr('style', 'display:none;');
                                $("#technicalMetadata_@(file.id.toString) > button").get(0).innerHTML = "Show file technical metadata";
                            }
                        });
                    </script>
                </div>
            </div>

			@if(!file.xmlMetadata.isEmpty) {
                <div id='xmlMetadata_@(file.id.toString)'>
                    <button class="tech_md_" type="button">Show XML-uploaded metadata</button>
                    <div style="display:none;">
                    <ul>
                            @printLevel(file.xmlMetadata)
                    </ul>
                    </div>
                </div>
                <script>
                    $("#xmlMetadata_@(file.id.toString) > button").on('click',function(){
                        if($("#xmlMetadata_@(file.id.toString) > div").attr('style') == 'display:none;'){
                            $("#xmlMetadata_@(file.id.toString) > div").attr('style', 'display:block;');
                            $("#xmlMetadata_@(file.id.toString) > button").get(0).innerHTML = "Hide file XML-uploaded metadata";
                        }
                        else{
                            $("#xmlMetadata_@(file.id.toString) > div").attr('style', 'display:none;');
                            $("#xmlMetadata_@(file.id.toString) > button").get(0).innerHTML = "Show file XML-uploaded metadata";
                        }
                    });
                </script>
            }


			<div class="row border-top">
				<div class="col-md-12">
					<h4>Extractions</h4>
					<a class="btn btn-link" data-toggle="collapse" href="#extractions" aria-expanded="false"
					aria-controls="collapseExample">
						List extraction events
					</a>
					<div class="collapse" id="extractions">
						@extractions.extractionsByFile(extractionsStatus)
					</div>
				</div>
			</div>

            <div class="row border-top">
                <div class="col-md-12">
                    <h4>Comments</h4>
                    @if(user.isDefined) {
                        @commentform(file.id.toString, "file")
                    }
                    <ol class="list-unstyled" id="reply_@file.id.toString">
                        @comment(comments)
                    </ol>
                </div>
            </div>


		</div>

        <div class="col-md-4">

            <div class="row ds-section-sm file-info">
                <table class="table table-condensed">
                    <tr><td><b>Filename:</b></td><td>@file.filename</td></tr>
                    <tr><td><b>Type:</b></td><td>@file.contentType</td></tr>
                    <tr><td><b>Uploaded on:</b></td><td>@file.uploadDate.format("MMM dd, yyyy HH:mm:ss")</td></tr>
                    <tr><td><b>Uploaded by:</b></td><td> <a href = "@routes.Profile.viewProfile(file.author.email)"> @file.author.fullName</a></td></tr>
                </table>
            </div>

            <!-- License elements-->
            <div class="row ds-section-sm border-top">
                <div class="accordion" id="accordion6">
                    <div class="accordion-group">
                        <div class="accordian-heading">
                            <h4>License</h4>

                            <table>
                                <tr>
                                    <td><b>Type: </b></td>
                                    <td id="licensetextdata" style="padding-left:10px;">blank</td>
                                </tr>
                                <tr>
                                    <td><b>Holder: </b></td>
                                    <td id="rightsholderdata" style="padding-left:10px;">blank</td>
                                </tr>
                            </table>
                                @if(user.isDefined) {
                                <a class="btn btn-link btn-sm accordion-toggle collapsed" data-toggle="collapse"
                                   data-parent="#accordion6" href="#collapseSix" id="editlicense"
                                   title="Edit License Information">
                                    <span class="glyphicon glyphicon-chevron-down"></span> Edit
                                </a>
                                }
                        </div>
                        <div id="collapseSix" class="accordion-body collapse">
                            <div class="panel panel-primary">
                                <div class="panel-body">
                                    @if(user.isDefined) {
                                      @licenseform(file.id.toString, file.licenseData, "file", file.author.fullName)
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script src="@routes.Assets.at("javascripts/recommendation.js")" type="text/javascript"></script>
                <script type="text/javascript" language="javascript">
                $(document).ready(function() {
                    //Will have to modify the if check to see if there is data that specifies what should be selected
                    //Incoming data may specifiy the type of license, the name of the owner of the rights, the text
                    //describing the license rights, the URL for the license, and whether or not downloading is
                    //allowed.
                    var fileLicenseType = "@file.licenseData.m_licenseType";
                    var fileRightsHolder = "@file.licenseData.m_rightsHolder";
                    var fileLicenseText = "@file.licenseData.m_licenseText";
                    var fileLicenseUrl = "@file.licenseData.m_licenseUrl";
                    var fileAllowDownload = "@file.licenseData.isDownloadAllowed(user)";
                    var fileImageBase = '@routes.Assets.at("images")';
                    var fileAuthorName = '@file.author.fullName';

                    if (!@user.isDefined){
                        updateInterface(fileLicenseType, fileRightsHolder, fileLicenseText, fileLicenseUrl, fileAllowDownload, fileImageBase, fileAuthorName);
                    }
                    
                    //Now, set the DownloadButton correctly (disabled or enabled as determined by the license)
                    var owner = "@file.author.fullName";
                    var userName = null;

                    @user match {
                        case None => {
                           userName = "";
                        }
                        case Some(x) => {
                           userName = "@user.getOrElse(null).fullName";
                        }
                    }
                    
                    //TODO:
                    //Create new route and new API call to check license info that is being done below by javascript
                    //Return true or false to allow or not allow the download. On good, proceed normally. On bad
                    //display appropriate message as an alert. (the else block from below is good example)
                    
                    //The checkLicenseType and checkAllowDownload variables are globally defined, and referenced from
                    //updateLicenseInfo.js.
                    //
                    //Check the license type, only type1 needs to have further checks, otherwise download should be allowed
                    if (fileLicenseType != 'license1') {
                        $("#downloadButton").removeAttr("disabled");
                        $("#downloadButton").attr("title", "Download the file");
                    }
                    //Check if the downloading of the file is allowed, however always allow the owner of the file to download it.
                    else {
                        if (fileAllowDownload == "true" || userName == owner) {
                        	$("#downloadButton").removeAttr("disabled");
                            $("#downloadButton").attr("title", "Download the file");    
                        }
                        else {
                        	$("#downloadButton").attr("disabled", "disabled");
                            $("#downloadButton").attr("title", "You don't have permission to download this file");
                        }
                    }

                    $(document).on('click', '.followButton', function() {
                        var id = $(this).attr('objectId');
                        var name = $(this).attr('objectName');
                        var type = $(this).attr('objectType');
                        if ($(this).attr('id') === '') {
                          followHandler.call(this, jsRoutes, id, name, type, undefined, undefined);
                        } else {
                          followHandler.call(this, jsRoutes, id, name, type, function(data) {
                                recommendationHandler(jsRoutes, $('#recommendPanel'), $('#recommendDiv'),
                                              data['recommendations']);
                            }, undefined);
                        }
                    });
                });

                function downloadFile() {
                    var downloadRoute = "@routes.Files.download(UUID(id))";
                    window.open(downloadRoute, '_blank');                    
                }
                </script>
            </div>
            <!-- End License elements -->

            <div class="row ds-section-sm border-top">
              <h4>Tags</h4>
              <ul id="tagList">
                  @file.tags.map { tag =>
                    <li><a href="@routes.Tags.search(tag.name)" id="@tag.name">@tag.name [File]</a>
                        <a href='javascript:void(0);'>
                            <i style='display:none;' id='@tag.name' class='glyphicon glyphicon-remove'></i></a></li>
                  }
                  @file.sections.map { section =>
                    @section.tags.map { tag =>
                      <li><a href="@routes.Tags.search(tag.name)">@tag.name [Section]</a></li>
                    }
                  }
              </ul>
              <form class="form-inline requiresLogin requiresLoginCommunity">
                <div class="input-group input-group-sm col-md-8">
                  <input type="text" id="tagField" class="form-control">
                  <span class="input-group-btn">
                        <button class="btn btn-default btn-large" id="tagB" title="Add Tag">
                            <span class="glyphicon glyphicon-tag"></span>
                        </button>
                  </span>                  
                </div>
              </form>
              <script language="javascript">
                window["userDefined"] = false;
              </script>
              @if(user.isDefined) {
                <script language="javascript">
                  window["userDefined"] = true;
                </script>
              }
              <script language="javascript">
                function removeTag() {
                  var tagId = $(this).attr("id");
                  console.log("Removing tag " + tagId);
                  
                  var request = jsRoutes.api.Files.removeTags('@file.id').ajax({
                    data: JSON.stringify({"tags":[tagId]}),
                    type: 'POST',
                    contentType: "application/json"
                  });

                  request.done(function (response, textStatus, jqXHR) {
                    console.log("Response " + textStatus);
                    $("#" + tagId).parents("li").remove();
                  });

                  request.fail(function (jqXHR, textStatus, errorThrown){
                	  console.error("The following error occured: " + textStatus, errorThrown);
                      var errMsg = "You must be logged in to remove a tag from a file.";                                
                      if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                          notify("The tag was not removed from the file due to : " + errorThrown, "error");
                      }    
                  });
                  
                  return false;
                }
              
                function removeIconMouseIn() {
                  $(this).find(".glyphicon-remove").fadeIn(100);
                }

                function removeIconMouseOut() {
                  $(this).find(".glyphicon-remove").fadeOut(100);           
                }

                $(function() {
                  if(window["userDefined"] == true)
                    $("#tagList").children("li").each(function(){
                      $(this).hover(
                        removeIconMouseIn,removeIconMouseOut
                      );
                    });
                  $("#tagList").find(".glyphicon-remove").click(removeTag);
                  
                  $('#tagB').click(function() {
                    var tag = $('#tagField').val();
                     
                    var isTagPresent = false;
                    $("#tagList").children("li").each(function (index, tagLi) {
                      if($(tagLi).attr("name")===tag) {
                        isTagPresent = true;
                      }
                    });
        
                    if (tag !== "" && isTagPresent != true) {
                      console.log("submitting tag " + tag);
                      var request = jsRoutes.api.Files.addTags('@file.id').ajax({
                        data: JSON.stringify({"tags":[tag]}),
                        type: 'POST',
                        contentType: "application/json",
                      });
                       
                      request.done(function (response, textStatus, jqXHR){
                        console.log("Response " + response);
                        var url = "../tags/search?tag=" + tag;
                        $newTag = $("<li><a href='" + url + "'>" + tag + " [File]</a><a href='javascript:void(0);'><i style='display:none;'id='" + tag +"' class='glyphicon glyphicon-remove'></i></a></li>").appendTo('#tagList');
                        $newTag.hover(removeIconMouseIn,removeIconMouseOut);
                        $newTag.find(".glyphicon-remove").click(removeTag);
                        $('#tagField').val("");
                       });
                  
                      request.fail(function (jqXHR, textStatus, errorThrown){
                    	  console.error("The following error occured: " + textStatus, errorThrown);
                          var errMsg = "You must be logged in to add a tag to a file.";                                
                          if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                              notify("The tag was not added to the file due to : " + errorThrown, "error");
                          }    
                      });
                      return false;
                    }
                  });
                  
                  $('#tagField').keypress(function (e) {
                  if (e.which == 13) {
                    console.log("enter");
                    $('#tagB').click();
                    return false;
                  }
                });
                
              });
            </script>           
            @if(!user.isDefined) {
              <script language="javascript">
                $(".requiresLogin").css("display","none");
              </script>
            }
            </div>


        <div class="row ds-section-sm border-top">
            <h4>Datasets containing the file</h4>
            @datasetsContainingFile(file, fileDataset, datasetsOutside)
        </div>

    </div> @* End of small right hand side column *@

	</div>

	@if(!user.isDefined) {
        <script language="javascript">
            $(".requiresLogin").css("display","none");
        </script>
    }

    @if(user.isDefined) {
        @if(!user.get.identityId.userId.equals(file.author.identityId.userId)){
            <script language="javascript">
                $(".requiresLogin:not(.requiresLoginCommunity)").css("display","none");
            </script>
        }
    }
}}

