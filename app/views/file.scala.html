@(file: models.File, id: String, comments: List[Comment],
  previews : Map[models.File, Array[(java.lang.String, String, String, String, java.lang.String, String, Long)]],
  sections: List[models.Section], beingProcessed: Boolean, fileDataset: List[models.Dataset],
  datasetsOutside: List[models.Dataset], usrmd: scala.collection.mutable.Map[String,Any],
  rdfExported: Boolean)(implicit user: Option[securesocial.core.Identity])

@import helper._
@import collection.JavaConverters._
@import play.api.Play.current
@implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

@printLevel(metadata: scala.collection.immutable.Map[String,Any]) = {
		@for((key,value) <- metadata) {
			<li><b>@(key):</b>
			@if(value.isInstanceOf[String]) {
				@if(value.asInstanceOf[String].startsWith("http://") || value.asInstanceOf[String].startsWith("https://")) {
					<a href="@value">@value</a>
				} else {
					@value
				}
			} else {
				@if(value.isInstanceOf[java.lang.Integer]) {
					@value.toString
			    } else {
			    	@if(value.isInstanceOf[com.mongodb.BasicDBList]) {
			    		@value.toString.replace("[","").replace("]","")
			    	} else {
			    		<ul>
			    		@printLevel(value.asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
			    		</ul>
			    	}
			    }
			}</li>
		}
	}

@showPreview(id: String, p: (java.lang.String, String, String, String, java.lang.String, String, Long), filename: String, contentType: String) = {
	<script>
		Configuration.tab = "#previewer_@id";
		Configuration.url = "@p._5";
		Configuration.fileid = "@p._1";
		Configuration.previewer = "@routes.Assets.at(p._3)";
		if("@p._2" === "Thumbnail"){
			Configuration.fileType = "@p._6";
			Configuration.fileSize = @p._7;
		}
		else if("@p._2" === "X3d"){
			Configuration.annotationsEditPath = "@api.routes.Previews.editAnnotation(UUID(p._1)))";
			Configuration.annotationsListPath = "@api.routes.Previews.listAnnotations(UUID(p._1))";
			Configuration.annotationsAttachPath = "@api.routes.Previews.attachAnnotation(UUID(p._1))";
			Configuration.wasPTM = "@(filename.endsWith(".ptm") || contentType.contains("ptmimages"))";
			Configuration.calledFrom = "file";
		}
		else if("@p._2" === "Oni"){			
		}
	</script>
	<script type="text/javascript" src="@(routes.Assets.at(p._3) + "/" + p._4)"></script>
}

@main("File") {	
    <script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/updateLicenseInfo.js")" language="javascript"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
    <script src="@routes.Assets.at("javascripts/previews.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/tinymce/tinymce.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/popcorn-complete.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/galleria-1.2.9.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/fileListProcess.js")" type="text/javascript"></script>
    
	<script>
		tinymce.init({selector:'.notesArea',
	    	theme: "modern",
	    	plugins: [
	    	          "advlist autolink lists link image charmap print preview hr anchor pagebreak",
	    	          "searchreplace wordcount visualblocks visualchars code fullscreen",
	    	          "insertdatetime media nonbreaking save table contextmenu directionality",
	    	          "template paste textcolor"
	    	      ],
	    	      toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
	    	      toolbar2: "print preview media | forecolor backcolor emoticons",
	    	      image_advtab: true,
	    	      templates: [
	    	          {title: 'Test template 1', content: 'Test 1'},
	    	          {title: 'Test template 2', content: 'Test 2'}
	    	      ]
	    });
	</script>
	<script>
    	var isPageLoaded = false;
    	var isx3dActive = false;
    	var Configuration = {};
    	Configuration.id  = "@file.id";
		Configuration.authenticated = @user.isDefined;
		Configuration.ptmAppletPath = "@(routes.Assets.at("plugins") + "/" + "envlib.jar")";
		Configuration.expressInstallPath = "@(routes.Assets.at("plugins") + "/" + "expressInstall.swf")";
		Configuration.iipZoomPath = "@(routes.Assets.at("plugins") + "/" + "IIPZoom.swf")";
		Configuration.jsPath = "@(routes.Assets.at("javascripts"))";
		Configuration.imagesPath = "@(routes.Assets.at("images"))";
		Configuration.appContext = "@play.api.Play.configuration.getString("application.context").getOrElse("")";
    </script>
    <script>
    	window.onload = function() {
    		isPageLoaded = true;
    	}
    </script>

	<div class="row">
		<div class="col-md-8 col-right-border">
		@for((f, pvs) <- previews) {
			<div class="row" id="filePrevContainer_@(f.id.toString)" data-previewsCount="@(pvs.length)" data-filename="@f.filename">
		    	<div class="col-md-12">
		    	<!-- 
		    	First check if there is only one previewer, and if the value of the URL for it is "null". If so
		    	that means there was no preview generated and the file is not allowed to be used due to the license
		    	that is on the file.
		    	 -->
		    	@if(pvs.length == 1 && pvs(0)._5 == "null") {
                    <h4>No previews currently available for this file</h4>
                } else {
			  		<div class="tabbable">
						<ul class="nav nav-pills" id="myTab_@(f.id.toString)">
							@for(i <- pvs.indices) {
					    		<li class=""><a href="#previewer_@(f.id.toString)_@i" data-toggle="tab">@pvs(i)._2</a></li>
			  				}
						</ul>
						<div class="tab-content"  id="previewsContent_@(f.id.toString)">						    						    
						    @for(i <- pvs.indices) {
						  		<div class="tab-pane previewDiv" id="previewer_@(f.id.toString)_@i" data-previewId="@(pvs(i)._1)" data-previewerId="@(pvs(i)._2)"></div>
						  		@showPreview(f.id.toString + "_" + i, pvs(i), f.filename, f.contentType)

							}							
				  			<script type="text/javascript">
								$(function () {
									$('#myTab_@(f.id.toString) a:first').tab('show');
				 				 })
							</script>
						</div>
					</div>
			    }
		  		</div>
			</div>
			@if(pvs.length <= 1) {
				<script>				
	    			$('#myTab_@(f.id.toString)').attr('style', 'display:none;');
	    		</script>
    		}

        <div class="row">
            <div class="col-md-12 button-margins">                
            	<span class="button-bar">
                    <button id="downloadButton" onclick="return downloadFile();" class="btn btn-primary" title="You don't have permission to download this file" disabled="disabled"><span class="glyphicon glyphicon-save"></span> Download</button>
                </span>
                @if(user.isDefined) {
                <!-- If user can delete, the button is enabled, otherwise the button is present but disabled to provide consistent UE. -->
                    @if(user.get.identityId.userId.equals(file.author.identityId.userId)){                    
                        <span class="align-right">
				            <button id="deleteButton" onclick="removeFileAndRedirect('@(file.id)','@(routes.Files.list(""))')" class="btn btn-primary" title="Delete">
						    <span class="glyphicon glyphicon-trash"></span> Delete</button>
					    </span>
					} else {
					    <span class="align-right">
                            <button disabled id="deleteButton" onclick="removeFileAndRedirect('@(file.id)','@(routes.Files.list(""))')" class="btn btn-primary" title="Delete">
                            <span class="glyphicon glyphicon-trash"></span> Delete</button>
                        </span>
					}					
				}				               
            </div>
        </div>

			<!-- sections -->
			@if(sections.size > 0) {
			  	<div class="row border-top">
			  	  <div class="col-md-12">
                    <h4>Sections</h4>
				  	<div id="galleria" style="float:left;clear:none;width:600px;height:300px;">
					  	@sections.map { s =>
					  		@if(s.preview.isDefined || s.thumbnail_id.isDefined) {
					  			@if(s.thumbnail_id.isDefined){
					  				<img src="@(routes.Files.thumbnail(UUID(s.thumbnail_id.toString().substring(5,s.thumbnail_id.toString().length-1))))"				  			
					  			} else {
					  				<img src="@api.routes.Previews.download(s.preview.get.id)"
					  			}					  			
					  				class="img-polaroid" height="100px"
					  			@if(s.startTime.isDefined) {
					  		 		data-title="Shot" data-description="Starts at @s.startTime seconds."
					  		 	} else {
					  		 		if (s.area.isDefined) {
					  		 			data-title="Area" data-description="@s.area.toString"
					  		 		} else {
										data-title="Unknown" data-description="Unknown info"
					  		 		}
					  		 	}
					  		 	></img>
					  		}
					  	}
				  	</div>
				  </div>
				</div>
				<div class="row" style="padding-top: 10px">
				    <div class="col-md-10">
						<table class="table">
							<thead>
								<tr>
									<th>#</th>
									<th>Thumbnail</th>
									<th>Information</th>
									<th>Find</th>
								</tr>
							</thead>
							<tbody>
					  		@sections.map { s =>
					  			<tr>
						  			<td>@(if (s.order > 0) s.order else "")</td>
						  			<td>
								  		@if(s.preview.isDefined || s.thumbnail_id.isDefined) {
								  			@if(s.thumbnail_id.isDefined){
								  				<img src="@(routes.Files.thumbnail(UUID(s.thumbnail_id.toString().substring(5,s.thumbnail_id.toString().length-1))))"				  			
								  			} else {
								  				<img src="@api.routes.Previews.download(s.preview.get.id)"
								  			}
								  				class="img-polaroid" style="max-width: 100px;max-height: 100px;"
								  			@if(s.startTime.isDefined) {
								  		 		data-title="Shot" data-description="Starts at @s.startTime seconds."
								  		 	} else {
								  		 		@if(s.area.isDefined) {
								  		 			data-title="Area" data-description="@s.area.toString"
								  		 		} else {
													data-title="Unknown" data-description="Unknown info"
								  		 		}
								  		 	}
								  		 	></img>
								  		}
					  				</td>
						  			 <td>
						  			 @if(s.startTime.isDefined) {
						  			 	@(s.startTime.get / 60):@("%02d".format(s.startTime.get % 60))
						  		 	 } else {
						  		 		@if(s.area.isDefined) {
						  		 			@s.area.get.toString
						  		 		} else {
											Unknown info
						  		 		}
						  		 	}
						  			 </td>
						  			 <td><a href="@routes.Search.searchMultimediaIndex(s.id)">Similar</a></td>
					  			 </tr>
					  		}
				  		</table>
				  	</div>
			  	</div>
				
				<script>
				    document.addEventListener("DOMContentLoaded", function () {
						if ($("#ourvideo").length>0) {
					        var pop = Popcorn("#ourvideo");

							@sections.map { s =>
					  			@if(s.startTime.isDefined) {
							   		pop.code({
								        start: @s.startTime,
								        onStart: function() {
								          var frame = @s.order - 1;
								          console.log("Jumping to " + frame + " " + @s.startTime);
								          $('#galleria').data('galleria').show(frame);
								        },
								        onEnd: function() {
								          //console.log("end");
								       }
								    });
								}
						    }
						}
				    });
		         </script>
			    
			    <script>
			    	$(function() {
					    // Load the classic theme
					    Galleria.loadTheme('@routes.Assets.at("javascripts/galleria-classic/galleria.classic.min.js")');

					    // Initialize Galleria
					    Galleria.run('#galleria');

					    var gallery = $('#galleria').data('galleria');

						Galleria.ready(function(options) {

						    // 'this' is the gallery instance
						    // 'options' is the gallery options

						    this.bind('image', function(e) {
						        Galleria.log('Now viewing ' + e.imageTarget.src);
						    });
						});


				    });
			    </script>
    			}
    		}

            <div class="row">
                <div class="col-md-12 border-top col-section">
                    <h4>Notes</h4>
                    @notesform(file.id.toString, api.routes.Files.setNotesHTML(file.id).toString, file.notesHTML.getOrElse(""))
                </div>
            </div>

            <div class="row border-top">
                <div class="col-md-12">
                    <h4>Community-generated metadata</h4>
                    @fileusermetadata(file, usrmd, rdfExported)
                </div>
            </div>

            <div class="row border-top">
                <div class="col-md-12">
                    <h4>System-generated metadata</h4>
                    <div id='technicalMetadata_@(file.id)'>
                        <button class="tech_md_" type="button">Show file technical metadata</button>
                        <div style="display:none;">
                        <ul>
                            @for(i <- 0 until file.metadata.length){
                                @printLevel(file.metadata(i).asInstanceOf[com.mongodb.BasicDBObject].toMap().asScala.asInstanceOf[scala.collection.mutable.Map[String, Any]].toMap)
                            }
                        </ul>
                        </div>
                    </div>
                    <script>
                        $("#technicalMetadata_@(file.id.toString) > button").on('click',function(){
                            if($("#technicalMetadata_@(file.id.toString) > div").attr('style') == 'display:none;'){
                                $("#technicalMetadata_@(file.id.toString) > div").attr('style', 'display:block;');
                                $("#technicalMetadata_@(file.id.toString) > button").get(0).innerHTML = "Hide file technical metadata";
                            }
                            else{
                                $("#technicalMetadata_@(file.id.toString) > div").attr('style', 'display:none;');
                                $("#technicalMetadata_@(file.id.toString) > button").get(0).innerHTML = "Show file technical metadata";
                            }
                        });
                    </script>
                </div>
            </div>

			@if(!file.xmlMetadata.isEmpty) {
                <div id='xmlMetadata_@(file.id.toString)'>
                    <button class="tech_md_" type="button">Show XML-uploaded metadata</button>
                    <div style="display:none;">
                    <ul>
                            @printLevel(file.xmlMetadata)
                    </ul>
                    </div>
                </div>
                <script>
                    $("#xmlMetadata_@(file.id.toString) > button").on('click',function(){
                        if($("#xmlMetadata_@(file.id.toString) > div").attr('style') == 'display:none;'){
                            $("#xmlMetadata_@(file.id.toString) > div").attr('style', 'display:block;');
                            $("#xmlMetadata_@(file.id.toString) > button").get(0).innerHTML = "Hide file XML-uploaded metadata";
                        }
                        else{
                            $("#xmlMetadata_@(file.id.toString) > div").attr('style', 'display:none;');
                            $("#xmlMetadata_@(file.id.toString) > button").get(0).innerHTML = "Show file XML-uploaded metadata";
                        }
                    });
                </script>
            }


            <div class="row border-top">
                <div class="col-md-12">
                    <h4>Comments</h4>
                    @if(user.isDefined) {
                    @commentform(file.id.toString, api.routes.Files.comment(file.id).toString)
                    }
                    <ol class="comment-threads unstyled" id="reply_@file.id.toString">
                        @comment(comments)
                    </ol>
                </div>
            </div>


		</div>

        <div class="col-md-4">

            <div class="row ds-section-sm file-info">
                <table class="table table-condensed">
                    <tr><td><b>Filename:</b></td><td>@file.filename</td></tr>
                    <tr><td><b>Type:</b></td><td>@file.contentType</td></tr>
                    <tr><td><b>Uploaded on:</b></td><td>@file.uploadDate.format("MMM dd, yyyy HH:mm:ss")</td></tr>
                    <tr><td><b>Uploaded by:</b></td><td> <a href = "@routes.Profile.viewProfile(file.author.email)"> @file.author.fullName</a></td></tr>
                </table>
            </div>

            <!-- License elements-->
            <div class="row ds-section-sm border-top">
                <div class="accordion" id="accordion6">
                    <div class="accordion-group">
                        <div class="accordian-heading">
                            <h4>License</h4>

                            <table>
                                <tr>
                                    <td><b>Type: </b></td>
                                    <td id="licensetextdata" style="padding-left:10px;">blank</td>
                                </tr>
                                <tr>
                                    <td><b>Holder: </b></td>
                                    <td id="rightsholderdata" style="padding-left:10px;">blank</td>
                                </tr>
                            </table>
                                @if(user.isDefined) {
                                <a class="btn btn-link btn-sm accordion-toggle collapsed" data-toggle="collapse"
                                   data-parent="#accordion6" href="#collapseSix" id="editlicense"
                                   title="Edit License Information">
                                    <span class="glyphicon glyphicon-chevron-down"></span> Edit
                                </a>
                                }
                        </div>
                        <div id="collapseSix" class="accordion-body collapse">
                            <div class="panel panel-primary">
                                <div class="panel-body">
                                    @if(user.isDefined) {
                                      @licenseform(file.id.toString, file.licenseData, "file", file.author.fullName)
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script type="text/javascript" language="javascript">
                $(document).ready(function() {
                    //Will have to modify the if check to see if there is data that specifies what should be selected
                    //Incoming data may specifiy the type of license, the name of the owner of the rights, the text
                    //describing the license rights, the URL for the license, and whether or not downloading is
                    //allowed.
                    var fileLicenseType = "@file.licenseData.m_licenseType";
                    var fileRightsHolder = "@file.licenseData.m_rightsHolder";
                    var fileLicenseText = "@file.licenseData.m_licenseText";
                    var fileLicenseUrl = "@file.licenseData.m_licenseUrl";
                    var fileAllowDownload = "@file.licenseData.isDownloadAllowed(user)";
                    var fileImageBase = '@routes.Assets.at("images")';
                    var fileAuthorName = '@file.author.fullName';

                    if (!@user.isDefined){
                        updateInterface(fileLicenseType, fileRightsHolder, fileLicenseText, fileLicenseUrl, fileAllowDownload, fileImageBase, fileAuthorName);
                    }
                    
                    //Now, set the DownloadButton correctly (disabled or enabled as determined by the license)
                    var owner = "@file.author.fullName";
                    var userName = null;

                    @user match {
                        case None => {
                           userName = "";
                        }
                        case Some(x) => {
                           userName = "@user.getOrElse(null).fullName";
                        }
                    }
                    
                    //TODO:
                    //Create new route and new API call to check license info that is being done below by javascript
                    //Return true or false to allow or not allow the download. On good, proceed normally. On bad
                    //display appropriate message as an alert. (the else block from below is good example)
                    
                    //The checkLicenseType and checkAllowDownload variables are globally defined, and referenced from
                    //updateLicenseInfo.js.
                    //
                    //Check the license type, only type1 needs to have further checks, otherwise download should be allowed
                    if (fileLicenseType != 'license1') {
                        $("#downloadButton").removeAttr("disabled");
                        $("#downloadButton").attr("title", "Download the file");
                    }
                    //Check if the downloading of the file is allowed, however always allow the owner of the file to download it.
                    else {
                        if (fileAllowDownload == "true" || userName == owner) {
                        	$("#downloadButton").removeAttr("disabled");
                            $("#downloadButton").attr("title", "Download the file");    
                        }
                        else {
                        	$("#downloadButton").attr("disabled", "disabled");
                            $("#downloadButton").attr("title", "You don't have permission to download this file");
                        }
                    }
                    
                });

                function downloadFile() {
                    var downloadRoute = "@routes.Files.download(UUID(id))";
                    window.open(downloadRoute, '_blank');                    
                }
                </script>
            </div>
            <!-- End License elements -->

            <div class="row ds-section-sm border-top">
              <h4>Tags</h4>
              <ul id="tagList">
                  @file.tags.map { tag =>
                    <li><a href="@routes.Tags.search(tag.name)" id="@tag.name">@tag.name [File]</a>
                        <a href='javascript:void(0);'>
                            <i style='display:none;' id='@tag.name' class='glyphicon glyphicon-remove'></i></a></li>
                  }
                  @file.sections.map { section =>
                    @section.tags.map { tag =>
                      <li><a href="@routes.Tags.search(tag.name)">@tag.name [Section]</a></li>
                    }
                  }
              </ul>
              <form class="form-inline requiresLogin requiresLoginCommunity">
                <div class="input-group input-group-sm col-md-8"">
                  <input type="text" id="tagField" class="form-control">
                  <span class="input-group-btn">
                        <button class="btn btn-default btn-large" id="tagB" title="Add Tag">
                            <span class="glyphicon glyphicon-tag"></span>
                        </button>
                  </span>                  
                </div>
              </form>
              <script language="javascript">
                window["userDefined"] = false;
              </script>
              @if(user.isDefined) {
                <script language="javascript">
                  window["userDefined"] = true;
                </script>
              }
              <script language="javascript">
                function removeTag() {
                  var tagId = $(this).attr("id");
                  console.log("Removing tag " + tagId);
                  
                  var request = jsRoutes.api.Files.removeTags('@file.id').ajax({
                    data: JSON.stringify({"tags":[tagId]}),
                    type: 'POST',
                    contentType: "application/json"
                  });

                  request.done(function (response, textStatus, jqXHR) {
                    console.log("Response " + textStatus);
                    $("#" + tagId).parents("li").remove();
                  });

                  request.fail(function (jqXHR, textStatus, errorThrown){
                	  console.error("The following error occured: " + textStatus, errorThrown);
                      var errMsg = "You must be logged in to remove a tag from a file.";                                
                      if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                          alert("The tag was not removed from the file due to : " + errorThrown);
                      }    
                  });
                  
                  return false;
                }
              
                function removeIconMouseIn() {
                  $(this).find(".glyphicon-remove").fadeIn(100);
                }

                function removeIconMouseOut() {
                  $(this).find(".glyphicon-remove").fadeOut(100);           
                }

                $(function() {
                  if(window["userDefined"] == true)
                    $("#tagList").children("li").each(function(){
                      $(this).hover(
                        removeIconMouseIn,removeIconMouseOut
                      );
                    });
                  $("#tagList").find(".glyphicon-remove").click(removeTag);
                  
                  $('#tagB').click(function() {
                    var tag = $('#tagField').val();
                     
                    var isTagPresent = false;
                    $("#tagList").children("li").each(function (index, tagLi) {
                      if($(tagLi).attr("name")===tag) {
                        isTagPresent = true;
                      }
                    });
        
                    if (tag !== "" && isTagPresent != true) {
                      console.log("submitting tag " + tag);
                      var request = jsRoutes.api.Files.addTags('@file.id').ajax({
                        data: JSON.stringify({"tags":[tag]}),
                        type: 'POST',
                        contentType: "application/json",
                      });
                       
                      request.done(function (response, textStatus, jqXHR){
                        console.log("Response " + response);
                        var url = "../tags/search?tag=" + tag;
                        $newTag = $("<li><a href='" + url + "'>" + tag + " [File]</a><a href='javascript:void(0);'><i style='display:none;'id='" + tag +"' class='glyphicon glyphicon-remove'></i></a></li>").appendTo('#tagList');
                        $newTag.hover(removeIconMouseIn,removeIconMouseOut);
                        $newTag.find(".glyphicon-remove").click(removeTag);
                        $('#tagField').val("");
                       });
                  
                      request.fail(function (jqXHR, textStatus, errorThrown){
                    	  console.error("The following error occured: " + textStatus, errorThrown);
                          var errMsg = "You must be logged in to add a tag to a file.";                                
                          if (!checkErrorAndRedirect(jqXHR, errMsg)) {
                              alert("The tag was not added to the file due to : " + errorThrown);
                          }    
                      });
                      return false;
                    }
                  });
                  
                  $('#tagField').keypress(function (e) {
                  if (e.which == 13) {
                    console.log("enter");
                    $('#tagB').click();
                    return false;
                  }
                });
                
              });
            </script>           
            @if(!user.isDefined) {
              <script language="javascript">
                $(".requiresLogin").css("display","none");
              </script>
            }
            </div>


        <div class="row ds-section-sm border-top">
            <h4>Datasets containing the file</h4>
            @datasetsContainingFile(file, fileDataset, datasetsOutside)
        </div>

    </div> @* End of small right hand side column *@




		@if(beingProcessed == true){
    			<div id='beingProcessed' style='display:block;'><h5>File is being processed...</h5></div>
    		}else{
    			<div id='beingProcessed' style='display:none;'><h5>File is being processed...</h5></div>
    		}
    		<script>
    			function updateIsBeingProcessed(){
    				var request = $.ajax({
 				       type: 'GET',
 				       url: "@api.routes.Files.isBeingProcessed(file.id)",
 				       contentType: "application/json"
 				     });
    				request.done(function (respJSON){
						if(respJSON.isBeingProcessed == "true")
							$("#beingProcessed").css('display','block');
						else
							$("#beingProcessed").css('display','none');
	     			});
				  request.fail(function (jqXHR, textStatus, errorThrown){
	        		console.error(
	            		"The following error occured: "+
	            		textStatus, errorThrown
	        			);
	        		//alert("ERROR: " + errorThrown +". Processing of dataset not checked." );
	     			});
    			}
    			$(function() {
    				setInterval("updateIsBeingProcessed();", 1000);
    			});
    		</script>
    		<script>
    			function addPreview(pv, fileId){
    				String.prototype.endsWith = function(str)
    				{
    				    var lastIndex = this.lastIndexOf(str);
    				    return (lastIndex != -1) && (lastIndex + str.length == this.length);
    				}

    				var prevsOfFile = parseInt($("#filePrevContainer_" + fileId).attr('data-previewsCount'))
    				var newTabLink = document.createElement('a');
    				newTabLink.setAttribute('href', '#previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				$("#filePrevContainer_" + fileId).attr('data-previewsCount', '' + (prevsOfFile + 1));
    				newTabLink.setAttribute('data-toggle', 'tab');
    				newTabLink.innerHTML= pv.p_id;
    				var newListItem = document.createElement('li');
    				newListItem.appendChild(newTabLink);
    				$("#myTab_" + fileId).append(newListItem);

    				var newPrevDiv = document.createElement('div');
    				newPrevDiv.setAttribute('class', 'tab-pane previewDiv');
    				newPrevDiv.setAttribute('id', 'previewer_' + fileId +  '_' + (prevsOfFile + 1));
    				newPrevDiv.setAttribute('data-previewId', pv.pv_id);
    				newPrevDiv.setAttribute('data-previewerId', pv.p_id);
    				$("#previewsContent_" + fileId).append(newPrevDiv);

    				//Previewer config vars
    				Configuration.tab = '#previewer_' + fileId +  '_' + (prevsOfFile + 1);
    				Configuration.url = pv.pv_route;
    				Configuration.fileid = pv.pv_id;
    				Configuration.previewer = pv.p_path;
    				if(pv.p_id === "Thumbnail"){
    					Configuration.fileType = pv.pv_contenttype;
    					Configuration.fileSize = pv.pv_length;
    				}
    				else if(pv.p_id === "X3d"){
    					Configuration.annotationsEditPath = pv.pv_annotationsEditPath;
    					Configuration.annotationsListPath = pv.pv_annotationsListPath;
    					Configuration.annotationsAttachPath = pv.pv_annotationsAttachPath;
    					if("@file.filename".endsWith(".ptm") || "@file.contentType".indexOf("ptmimages") != -1)
    						Configuration.wasPTM = 'true';
    					else
    						Configuration.wasPTM = 'false';
    					Configuration.calledFrom = "file";
    				}
    				////

    				var s = document.createElement("script");
    				s.type = "text/javascript";
    				s.src = pv.p_path + "/" + pv.p_main;
    				$("#previewsContent_" + fileId).append(s);

    				if(prevsOfFile == 1){
    					$("#myTab_" + fileId).attr('style', 'display:block;');
    				}

    				$('#myTab_' + fileId + ' a:first').tab('show');
    			}

    			function checkForNewPreviews(){
	    			var request = $.ajax({
					       type: 'GET',
					       url: "@api.routes.Files.getPreviews(file.id)",
					       contentType: "application/json"
					     });
					request.done(function (respJSON){
							//alert(JSON.stringify(respJSON));
						for(var i = 0; i < respJSON.length; i++){
							var pvs = respJSON[i].previews;
							for(var j = 0; j < pvs.length; j++){
								var pvId = pvs[j].pv_id;
								var pId = pvs[j].p_id;
								if($(".previewDiv[data-previewId='" + pvId + "'][data-previewerId='" + pId + "']").length == 0){
									addPreview(pvs[j], respJSON[i].file_id);
								}
							}
						}
						setTimeout("checkForNewPreviews();", 1000);
		     		});
					  request.fail(function (jqXHR, textStatus, errorThrown){
		        		console.error(
		            		"The following error occured: "+
		            		textStatus, errorThrown
		        			);
		        		setTimeout(function(){checkForNewPreviews()}, 1000);
		     			});
				}
    			$(function() {
    				setTimeout(function(){checkForNewPreviews()}, 1000);
    			});
    		</script>
	</div>
	
	@if(!user.isDefined) {
     	   <script language="javascript">
     			$(".requiresLogin").css("display","none");
       	   </script>
     	 }
     	 @if(user.isDefined) {
     	 	@if(!user.get.identityId.userId.equals(file.author.identityId.userId)){
      	   		<script language="javascript">
	     			$(".requiresLogin:not(.requiresLoginCommunity)").css("display","none");
	       		</script>
       		}
     	 }
}

